<!doctype html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<th:block th:replace="~{layout :: main(~{::section})}">
    <section>
        <!-- Null-safe název: když by t/nazev nebyl, ať stránka nespadne -->
        <h1 th:text="${t != null && t.nazev != null ? t.nazev : 'Detail pojistky'}">Detail pojistky</h1>
        <br>

        <dl class="row">
            <dt class="col-sm-3">Částka</dt>
            <!-- Peníze naformátované + fallback na 0 Kč -->
            <dd class="col-sm-9"
                th:text="${t != null && t.castka != null
                          ? #numbers.formatDecimal(t.castka,0,'COMMA',2,'POINT') + ' Kč'
                          : '0 Kč'}">0 Kč</dd>

            <dt class="col-sm-3">Platnost od</dt>
            <dd class="col-sm-9">
                <span th:if="${t != null && t.platnostOd != null}"
                      th:text="${#temporals.format(t.platnostOd,'dd.MM.yyyy')}">—</span>
                <span th:if="${t == null || t.platnostOd == null}">—</span>
            </dd>

            <dt class="col-sm-3">Platnost do</dt>
            <dd class="col-sm-9">
                <span th:if="${t != null && t.platnostDo != null}"
                      th:text="${#temporals.format(t.platnostDo,'dd.MM.yyyy')}">—</span>
                <span th:if="${t == null || t.platnostDo == null}">—</span>
            </dd>

            <dt class="col-sm-3">Pojištěný (ID)</dt>
            <dd class="col-sm-9">
                <!-- ADMIN: klikací odkaz -->
                <a sec:authorize="hasRole('ADMIN')"
                   th:if="${t != null && t.pojisteny != null}"
                   th:href="@{/pojistenci/detail/{id}(id=${t.pojisteny.id})}"
                   th:text="${t.pojisteny.id}">0</a>
                <span sec:authorize="hasRole('ADMIN')" th:if="${t == null || t.pojisteny == null}">—</span>

                <!-- USER: jen text -->
                <span sec:authorize="!hasRole('ADMIN')"
                      th:text="${t != null && t.pojisteny != null ? t.pojisteny.id : '—'}">—</span>
            </dd>
        </dl>

        <!-- Akce k pojistce -->
        <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
            <a sec:authorize="hasRole('ADMIN')"
               th:href="@{/pojistky/edit/{id}(id=${t.id})}" class="btn btn-warning">Editovat</a>

            <form sec:authorize="hasRole('ADMIN')"
                  th:action="@{/pojistky/delete/{id}(id=${t.id})}" method="post" class="d-inline"
                  onsubmit="return confirm('Smazat pojistku?')">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="btn btn-danger" type="submit">Odstranit</button>
            </form>

            <a sec:authorize="hasRole('ADMIN')"
               th:if="${t != null && t.pojisteny != null}"
               th:href="@{/pojistenci/detail/{id}(id=${t.pojisteny.id})}" class="btn btn-secondary">
                Zpět na pojištěnce
            </a>

            <a sec:authorize="hasRole('ADMIN')" th:href="@{/pojistky}" class="btn btn-secondary">
                Zpět na výpis pojistek
            </a>
        </div>

        <hr class="my-4">

        <!-- OSOBY K TÉTO POJISTCE -->
        <div class="card mt-4">
            <div class="card-header bg-light fw-semibold">Osoby na které se pojistka vztahuje</div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0 align-middle">
                    <thead>
                    <tr>
                        <th>Jméno</th>
                        <th>Role</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Null-safe iterace -->
                    <tr th:each="o : ${osobyKpojistce}">
                        <td>
                            <a sec:authorize="hasRole('ADMIN')"
                               th:href="@{|/pojistenci/detail/${o.id}|}"
                               th:text="${(o.jmeno == null ? '' : o.jmeno) + ' ' + (o.prijmeni == null ? '' : o.prijmeni)}">Jméno</a>
                            <span sec:authorize="!hasRole('ADMIN')"
                                  th:text="${(o.jmeno == null ? '' : o.jmeno) + ' ' + (o.prijmeni == null ? '' : o.prijmeni)}">Jméno</span>
                        </td>
                        <td>
                            <span class="badge"
                                  th:classappend="${o.role}=='POJISTNIK' ? ' text-bg-primary' : ' text-bg-secondary'"
                                  th:text="${o.role}">POJISTENY</span>
                        </td>
                    </tr>
                    <tr th:if="${osobyKpojistce == null or #lists.isEmpty(osobyKpojistce)}">
                        <td colspan="2" class="text-center text-muted py-3">
                            Zatím nejsou navázané žádné osoby.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</th:block>
</html>
